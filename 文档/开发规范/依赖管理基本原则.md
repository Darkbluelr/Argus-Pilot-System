# 依赖管理基本原则

## 1. 引言

Argus Pilot System 项目依赖于外部库、框架和服务来构建功能。有效的依赖管理对于确保构建的可重复性、环境一致性、安全性和可维护性至关重要。本文档概述了本项目管理外部依赖的基本原则。

## 2. 核心原则

*   **明确记录 (Explicit Recording):** 所有项目的直接依赖及其版本必须在指定的依赖管理文件中明确记录。
*   **版本锁定 (Version Locking):** 应锁定所有依赖项（包括间接依赖）的确切版本，以确保在不同环境（开发、测试、生产）和不同时间点都能构建出完全相同的软件。
*   **最小化依赖 (Minimize Dependencies):** 谨慎引入新的依赖。优先考虑使用标准库或现有依赖的功能。评估新依赖的质量、维护状态、许可证和安全风险。
*   **定期更新 (Regular Updates):** 应定期审查和更新依赖项到较新版本，以获取 Bug 修复、性能改进和安全补丁。但更新需谨慎，并进行充分测试。
*   **安全性扫描 (Security Scanning):** 定期使用工具扫描项目依赖，检查已知的安全漏洞。

## 3. 使用工具与文件

*   **包管理器 (Package Manager):** **Poetry** (推荐) 或 PDM。提供依赖解析、版本锁定和虚拟环境管理。
*   **依赖记录文件:** `pyproject.toml` (`[tool.poetry.dependencies]` / `[project.dependencies]` 部分) - *记录直接依赖及其版本约束 (例如 `^1.0` 或 `>=1.0,<2.0`)。*
*   **锁定文件 (Lock File):** `poetry.lock` (由 Poetry 生成) 或 `pdm.lock` (由 PDM 生成) - *记录所有直接和间接依赖的精确版本。**此文件必须纳入版本控制。***

**本项目优先推荐使用 Poetry 进行依赖管理。**

## 4. 依赖管理流程

*   **添加新依赖:**
    1.  **评估:** 讨论并评估引入新依赖的必要性和风险。检查其 PyPI 页面、文档、社区活跃度、许可证 (确保与项目开源许可证兼容) 和已知漏洞。
    2.  **添加:** 使用 `poetry add <package>` 命令添加依赖。Poetry 会自动更新 `pyproject.toml` 并解析依赖，更新 `poetry.lock`。
    3.  **提交:** 将更新后的 `pyproject.toml` 和 `poetry.lock` 文件一起提交到版本控制。
*   **更新依赖:**
    1.  **检查更新:** 定期（例如每月或每个重要版本前）运行 `poetry show --outdated` 查看可更新的依赖。
    2.  **评估风险:** 评估更新（尤其是主版本更新）可能带来的破坏性变更和兼容性问题。查阅库的更新日志。
    3.  **执行更新:** 运行 `poetry update <package>` (更新特定包) 或 `poetry update` (更新所有可更新的包，需谨慎)。Poetry 会更新 `poetry.lock`。
    4.  **测试:** **运行完整的测试套件** (`pytest`) 以确保更新没有引入回归问题。
    5.  **提交:** 确认无误后，提交更新后的 `poetry.lock` 文件。对于重要依赖的更新，建议在单独的分支和 PR 中进行。
*   **移除依赖:**
    1.  **确认:** 确保该依赖不再被项目代码 (`src/`) 使用。
    2.  **移除:** 使用 `poetry remove <package>` 命令移除依赖。Poetry 会更新 `pyproject.toml` 和 `poetry.lock`。
    3.  **测试:** 运行测试确保移除未导致问题。
    4.  **提交:** 提交更新后的文件。
*   **处理依赖冲突:** Poetry 在添加或更新依赖时会自动尝试解决版本冲突。如果无法解决，它会报错。需要手动调整 `pyproject.toml` 中的版本约束，然后运行 `poetry lock` 或 `poetry update` 再次尝试解决。

## 5. 环境管理

*   **虚拟环境:** **必须**为本项目使用由 Poetry 管理的独立虚拟环境。运行 `poetry install` 会自动创建或使用虚拟环境，并安装锁定文件 (`poetry.lock`) 中指定的依赖。
*   **环境重建:** 在新的机器或 CI 环境中，只需签出代码库（包含 `pyproject.toml` 和 `poetry.lock`），然后运行 `poetry install` 即可快速、可靠地重建完全相同的开发/测试环境。`README.md` 中应包含此步骤。

## 6. 安全性

*   **漏洞扫描:** 推荐在 CI 流程中集成 `pip-audit` 或使用 GitHub Dependabot alerts/security scanning 来检查 `poetry.lock` 文件中的依赖是否存在已知漏洞。
*   **及时响应:** 对于发现的高危漏洞，应尽快评估其对项目的影响，并按照"更新依赖"流程进行修复。

## 7. AI 助手与依赖管理

*   AI 助手在建议添加新依赖时，应检查 `pyproject.toml` 是否已包含，并说明添加的理由。
*   AI 助手在生成涉及外部库的代码时，应优先使用已在 `pyproject.toml` 中声明的库。
*   可以利用 AI 助手辅助查找特定库的文档、更新日志或替代方案。
*   AI 助手在修改代码时，如果移除了对某个库的使用，应提示开发者考虑运行 `poetry remove <package>`。
